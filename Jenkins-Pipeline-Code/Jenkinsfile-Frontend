pipeline {
    agent any

    tools {
        jdk 'jdk'
        nodejs 'nodejs'
    }

    environment {
        SCANNER_HOME        = tool 'sonar-scanner'

        AWS_ACCOUNT_ID      = credentials('ACCOUNT_ID')
        AWS_ECR_REPO_NAME   = credentials('ECR_REPO1')
        AWS_DEFAULT_REGION = 'ap-south-1'
        REPOSITORY_URI     = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"

        GIT_REPO_NAME      = "End-to-End-Kubernetes-Three-Tier-DevSecOps-Project"
        GIT_BRANCH         = "master"
        GIT_USER_NAME      = "pratyush934"
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout Repository') {
            steps {
                git branch: "${GIT_BRANCH}",
                    credentialsId: 'github-cred',
                    url: "https://github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git"
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('Application-Code/frontend') {
                    withSonarQubeEnv('sonar') {
                        sh """
                          ${SCANNER_HOME}/bin/sonar-scanner \
                          -Dsonar.projectName=frontend \
                          -Dsonar.projectKey=frontend
                        """
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: false, credentialsId: 'sonar-token'
            }
        }

        stage('Trivy Filesystem Scan') {
            steps {
                dir('Application-Code/frontend') {
                    sh 'trivy fs . > trivy-fs-report.txt'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('Application-Code/frontend') {
                    sh """
                      docker build -t ${AWS_ECR_REPO_NAME}:${BUILD_NUMBER} .
                    """
                }
            }
        }

        stage('Push Image to AWS ECR') {
            steps {
                sh """
                  aws ecr get-login-password --region ${AWS_DEFAULT_REGION} \
                  | docker login --username AWS --password-stdin ${REPOSITORY_URI}

                  docker tag ${AWS_ECR_REPO_NAME}:${BUILD_NUMBER} \
                  ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}

                  docker push ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}
                """
            }
        }

        stage('Trivy Image Scan') {
            steps {
                sh """
                  trivy image \
                  ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER} \
                  > trivy-image-report.txt
                """
            }
        }

        stage('Update Kubernetes Deployment (GitOps)') {
            steps {
                dir('Kubernetes-Manifests-file/Frontend') {
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'github-cred',
                            usernameVariable: 'GIT_USERNAME',
                            passwordVariable: 'GITHUB_TOKEN'
                        )
                    ]) {
                        sh """
                          git config user.email "pratyushsinha982@gmail.com"
                          git config user.name "${GIT_USER_NAME}"

                          sed -i 's|image: .*frontend:.*|image: ${REPOSITORY_URI}/${AWS_ECR_REPO_NAME}:${BUILD_NUMBER}|' deployment.yaml

                          git add deployment.yaml
                          git commit -m "chore: update frontend image to ${BUILD_NUMBER}" || echo "No changes to commit"

                          git push https://${GIT_USERNAME}:${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git ${GIT_BRANCH}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '*.txt', fingerprint: true
        }
    }
}
